<script>
    "use strict";
    async function captureDesktop() {
        const localStream = await navigator.mediaDevices.getDisplayMedia({
            video: {
                frameRate: 15,
                displaySurface: "window",
            },
        });
        consolelog("make Offer");
        const peer = new RTCPeerConnection({ iceServers: [] });
        peer.onsignalingstatechange = () => {
            consolelog("onsignalingstatechange", peer.signalingState);
        };
        peer.onicecandidateerror = (evt) => {
            consolelog("onicecandidateerror", evt);
        };
        peer.onsignalingstatechange = () => {
            consolelog("onsignalingstatechange", peer.signalingState);
        };
        peer.oniceconnectionstatechange = () => {
            consolelog("oniceconnectionstatechange", peer.iceConnectionState);
        };
        peer.onicegatheringstatechange = () => {
            consolelog("onicegatheringstatechange", peer.iceGatheringState);
        };
        peer.onconnectionstatechange = () => {
            consolelog("onconnectionstatechange", peer.connectionState);
        };
        consolelog("Adding local stream...");
        peer.addStream(localStream);
        const localDescription = await peer.createOffer();
        consolelog("createOffer() succsess in promise");
        await peer.setLocalDescription(localDescription);
        consolelog("setLocalDescription() succsess in promise");
        const localSdpText = await new Promise((resolve) => {
            peer.onicecandidate = (evt) => {
                if (evt.candidate != null) {
                    consolelog("ice event", evt.candidate);
                    // Trickle ICE の場合は、ICE candidateを相手に送る
                    // Vanilla ICE の場合には、何もしない
                } else {
                    consolelog("empty ice event");
                    // Trickle ICE の場合は、何もしない
                    // Vanilla ICE の場合には、ICE candidateを含んだSDPを相手に送る
                    consolelog("---sending sdp ---");
                    // consolelog(peer.localDescription.sdp);
                    resolve(peer.localDescription.sdp);
                }
            };
        });
        const textarea = document.createElement("textarea");
        textarea.value = localSdpText;
        textarea.readonly = true;
        textarea.onclick = async () => {
            textarea.focus();
            textarea.select();
            await navigator.clipboard.writeText(localSdpText);
        };
        document.body.appendChild(textarea);
        const textarea2 = document.createElement("textarea");
        textarea2.placeholder = "paste remote sdp here";
        textarea2.onclick = async () => {
            textarea2.value = await navigator.clipboard.readText();
            textarea2.focus();
            textarea2.select();
        };
        document.body.appendChild(textarea2);
        const button = document.createElement("button");
        button.appendChild(document.createTextNode("Receive Offer"));
        document.body.appendChild(button);
        await new Promise((resolve) => { button.onclick = resolve; });
        const remoteSdpText = textarea2.value;
        consolelog("Received answer text...");
        consolelog(remoteSdpText);
        document.body.removeChild(button);
        document.body.removeChild(textarea);
        document.body.removeChild(textarea2);
        const answerSdp = new RTCSessionDescription({
            type: "answer",
            sdp: remoteSdpText,
        });
        await peer.setRemoteDescription(answerSdp);
        consolelog("setRemoteDescription(answer) succsess in promise");
        await new Promise((resolve) => {
            peer.oniceconnectionstatechange = () => {
                consolelog("oniceconnectionstatechange", peer.iceConnectionState);
                if (peer.iceConnectionState === "disconnected") {
                    resolve();
                }
            };
        });
        consolelog("Hang up.");
        peer.close();
    }


    async function receiveDesktop() {
        const textarea = document.createElement("textarea");
        textarea.placeholder = "paste remote sdp here";
        textarea.onclick = async () => {
            textarea.value = await navigator.clipboard.readText();
            textarea.focus();
            textarea.select();
        };
        document.body.appendChild(textarea);
        const button = document.createElement("button");
        button.appendChild(document.createTextNode("Receive Offer"));
        document.body.appendChild(button);
        await new Promise((resolve) => { button.onclick = resolve; });
        const remoteSdpText = textarea.value;
        consolelog("Received offer text...");
        // consolelog(remoteSdpText);
        document.body.removeChild(textarea);
        document.body.removeChild(button);
        const offerSdp = new RTCSessionDescription({
            type: "offer",
            sdp: remoteSdpText,
        });
        const peer = new RTCPeerConnection({ iceServers: [] });
        peer.onsignalingstatechange = () => {
            consolelog("onsignalingstatechange", peer.signalingState);
        };
        peer.onicecandidateerror = (evt) => {
            consolelog("onicecandidateerror", evt);
        };
        peer.oniceconnectionstatechange = () => {
            consolelog("oniceconnectionstatechange", peer.iceConnectionState);
        };
        peer.onicegatheringstatechange = () => {
            consolelog("onicegatheringstatechange", peer.iceGatheringState);
        };
        peer.onconnectionstatechange = () => {
            consolelog("onconnectionstatechange", peer.connectionState);
        };
        const video = document.createElement("video");
        peer.ontrack = (event) => {
            consolelog("ontrack", event);
            const remoteStream = event.streams[0];
            video.muted = true;
            video.volume = 0;
            video.autoplay = true;
            video.playsinline = true;
            video.controls = true;
            video.srcObject = remoteStream;
        };
        peer.onremovestream = (event) => {
            consolelog("onremovestream", event);
            video.pause();
            video.srcObject = null;
        };
        await peer.setRemoteDescription(offerSdp);
        consolelog("setRemoteDescription(offer) succsess in promise");
        consolelog("sending Answer. Creating remote session description...");
        const localDescription = await peer.createAnswer();
        consolelog("createAnswer() succsess in promise");
        await peer.setLocalDescription(localDescription);
        consolelog("setLocalDescription() succsess in promise");
        // -- Trickle ICE の場合は、初期SDPを相手に送る -- 
        // -- Vanilla ICE の場合には、まだSDPは送らない --
        //sendSdp(peerConnection.localDescription);
        const localSdpText = await new Promise((resolve) => {
            peer.onicecandidate = function (evt) {
                if (evt.candidate != null) {
                    consolelog("ice event", evt.candidate);
                    // Trickle ICE の場合は、ICE candidateを相手に送る
                    // Vanilla ICE の場合には、何もしない
                } else {
                    consolelog("empty ice event");
                    // Trickle ICE の場合は、何もしない
                    // Vanilla ICE の場合には、ICE candidateを含んだSDPを相手に送る
                    consolelog("---sending sdp ---");
                    // consolelog(peer.localDescription.sdp);
                    resolve(peer.localDescription.sdp);
                }
            };
        });
        const textarea2 = document.createElement("textarea");
        textarea2.value = localSdpText;
        textarea2.readonly = true;
        textarea2.onclick = async () => {
            textarea2.focus();
            textarea2.select();
            await navigator.clipboard.writeText(localSdpText);
        };
        document.body.appendChild(textarea2);
        await new Promise((resolve) => {
            peer.oniceconnectionstatechange = () => {
                consolelog("oniceconnectionstatechange", peer.iceConnectionState);
                if (peer.iceConnectionState === "connected") {
                    resolve();
                }
            };
        });
        document.body.removeChild(textarea2);
        document.body.appendChild(video);
        video.play();
        await new Promise((resolve) => {
            peer.oniceconnectionstatechange = () => {
                consolelog("oniceconnectionstatechange", peer.iceConnectionState);
                if (peer.iceConnectionState === "disconnected") {
                    resolve();
                }
            };
        });
        consolelog("Hang up.");
        peer.close();
        video.pause();
        video.srcObject = null;
        document.body.removeChild(video);
    }


    const logarea = document.createElement("textarea");
    function consolelog(...args) {
        console.log(...args);
        logarea.appendChild(document.createTextNode(args.join(" ") + "\n"));
    }
    window.onerror = (message, source, lineno, colno, error) => {
        consolelog(message, source, lineno, colno, error);
    };
    window.addEventListener("unhandledrejection", (evt) => {
        consolelog(["onUnhandledrejection", evt.reason.stack].join("\n--------\n"));
    });
    document.addEventListener("DOMContentLoaded", (ev) => {
        logarea.style = "display: block; width: 100%; height: 200px;";
        logarea.readonly = true;
        logarea.onclick = async () => {
            logarea.focus();
            logarea.select();
            await navigator.clipboard.writeText(logarea.value);
        };
        document.body.appendChild(logarea);
        const button1 = document.createElement("button");
        const button2 = document.createElement("button");
        button1.appendChild(document.createTextNode("captureDesktop"));
        button2.appendChild(document.createTextNode("receiveDesktop"));
        button1.onclick = () => {
            document.body.removeChild(button1);
            document.body.removeChild(button2);
            captureDesktop();
        };
        button2.onclick = () => {
            document.body.removeChild(button1);
            document.body.removeChild(button2);
            receiveDesktop();
        };
        document.body.appendChild(button1);
        document.body.appendChild(button2);
    });
</script>

<body>
</body>